<!DOCTYPE html>
<html lang="en">

<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Product Management</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<link rel="stylesheet" href="/admin/admin.css">
</head>
<style>
	.search input {
		border-radius: 20px;
	}
</style>

<body>
	<div class="sidebar">
		<div class="sidebar-brand">
			H E L D E N
		</div>
		<ul class="nav flex-column mt-3">
			<li class="nav-item">
				<a class="nav-link" href="/admin/dashboard">Dashboard</a>
			</li>
			<li class="nav-item">
				<a class="nav-link" href="/admin/userManagement">User Management</a>
			</li>
			<li class="nav-item">
				<a class="nav-link active" href="/admin/productManagement">Product Management</a>
			</li>
			<li class="nav-item">
				<a class="nav-link" href="/admin/orderManagement">Order Management</a>
			</li>
			<li class="nav-item">
				<a class="nav-link" href="/admin/categoryManagement">Category Management</a>
			</li>
			<li class="nav-item">
				<a class="nav-link" href="/admin/couponManagement">Coupon Management</a>
			</li>
			<li class="nav-item mt-5">
				<a class="nav-link text-warning" href="/admin/logout">Logout</a>
			</li>
		</ul>
	</div>
	<div class="main-content container-fluid">
		<h2 class="mb-4 pt-3">Product Management</h2>
		<form class="nav-link mt-2 mt-md-0 d-lg-flex search">
			<input type="text" class="form-control" placeholder="Search users">
			<button style=" margin-left: 10px;" class="btn btn-primary">Search</button>
		</form>
		<div class="table-responsive">
			<table class="table-hover">
				<thead>
					<tr>
						<th>Index</th>
						<th>Name</th>
						<th>Category</th>
						<th>Price</th>
						<th>Stock</th>
						<th>Created Date</th>
						<th>Updated Date</th>
						<th>Actions</th>
					</tr>
				</thead>
				<tbody>
					<% products.forEach((product, index) => { %>
					<tr id="product-<%= product._id %>">
						<td><%= index + 1 %></td>
						<td><%= product.name %></td>
						<td>
							<% if (product.category !== null) { %>
							<%= product.category.name %>
							<% } else { %>
							<span class="text-muted">NO</span>
							<% } %>
						</td>
						<td>$<%= product.price %></td>
						<td>
							<% if (Array.isArray(product.stockManagement) && product.stockManagement.length > 0) { %>
							<%= product.stockManagement.reduce((total, stock) => total + stock.quantity, 0) %>
							<% } else { %>
							<span class="text-muted">No Stock</span>
							<% } %>
						</td>
						<td><%= new Date(product.createdAt).toLocaleDateString() %></td>
						<td><%= new Date(product.updatedAt).toLocaleDateString() %></td>
						<td>
							<a href="/admin/productManagement/update/<%= product._id %>" class="btn btn-outline-primary btn-sm">Update</a>
							<button data-id="<%= product._id %>" class="btn btn-outline-danger btn-sm btn-delete">Delete</button>
						</td>
					</tr>
					<% }); %>
				</tbody>
			</table>
		</div>

		<div class="action-buttons">
			<button class="btn btn-success btn-custom" id="btn-add-prod">
				Create New Product
			</button>
			<button class="btn btn-warning btn-custom" id="btn-del-prod">
				Deleted Products
			</button>
		</div>
	</div>

	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
	<script>
		// SOFT DELETE PRODUCT
		document.querySelectorAll('.btn-delete').forEach(button => {
			button.addEventListener('click', function(e) {
				const productId = e.target.getAttribute('data-id');

				Swal.fire({
					title: 'Are you sure?',
					text: "You won't be able to undo this action!",
					icon: 'warning',
					showCancelButton: true,
					confirmButtonColor: '#3085d6',
					cancelButtonColor: '#d33',
					confirmButtonText: 'Yes, delete it!'
				}).then((result) => {
					if(result.isConfirmed) {
						fetch(`/admin/productManagement/unlink`, {
								method: 'PUT',
								headers: {
									'Content-Type': 'application/json'
								},
								body: JSON.stringify({
									productId
								})
							})
							.then(response => response.json())
							.then(data => {
								if(data.success) {
									Swal.fire('Deleted!', 'Product has been deleted.', 'success');
									window.location.reload();
								} else {
									Swal.fire('Error!', 'Could not delete the product.', 'error');
								}
							})
							.catch(error => {
								console.error('Error:', error);
								Swal.fire('Error!', 'An unexpected error occurred.', 'error');
							});
					}
				});
			});
		});

		// ADDING PRODUCT
		document.getElementById('btn-add-prod').addEventListener('click', () => {
			window.location.href = '/admin/productManagement/add';
		});

		// DELETED PRODUCTS
		document.getElementById('btn-del-prod').addEventListener('click', () => {
			window.location.href = '/admin/productManagement/deleted';
		});
	</script>
</body>

</html>