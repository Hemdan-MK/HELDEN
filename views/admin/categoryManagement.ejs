<!DOCTYPE html>
<html lang="en">

<head>
<!-- Required meta tags -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Category Panel</title>
<!-- Bootstrap CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="/admin/admin.css">
</head>

<body>
	<div class="container-scroller">
		<!-- Sidebar -->
		<%- include('./layout/sidebar') %>

		<!-- Page Content -->
		<div class="container-fluid page-body-wrapper">
			<!-- Navbar -->
			<nav class="navbar navbar-expand-lg navbar-light fixed-top">
				<!-- <a class="navbar-brand bg-transparent text-danger " href="/admin/categoryManagement">Category Panel</a> -->
			</nav>

			<!-- Main Content -->
			<div class="container mt-5 pt-4">
				<div class="row mb-4">
					<div class="col-12">
						<h4 class="text-center h1">Category Management</h4>
					</div>
				</div>

				<!-- Search Form -->
				<div class="row mb-3">
					<div class="col-md-6 offset-md-3">
						<form class="form-inline justify-content-around">
							<input type="text" class="form-control mr-2 w-75" placeholder="Search categories">
							<button class="btn btn-primary">Search</button>
						</form>
					</div>
				</div>

				<!-- Categories Table -->
				<div class="row">
					<div class="col-12">
						<div class="table-responsive table-bordered border-danger">
							<table class="table table-borderless table-hover">
								<thead class="thead-dark">
									<tr>
										<th>Index</th>
										<th>Name</th>
										<th>Picture</th>
										<th>Product Count</th>
										<th>Created Date</th>
										<th>Updated Date</th>
										<th>Update</th>
										<th>Status</th>
									</tr>
								</thead>
								<tbody>
									<% categoriesWithCounts.forEach((category, index)=> { %>
									<tr id="category-<%= category._id %>">
										<td>
											<%= index + 1 %>
										</td>
										<td>
											<%= category.name %>
										</td>
										<td><img src="<%= category.image %>" class="img-thumbnail" style="width: 60px; height: 60px;">
										</td>
										<td>
											<%= category.productCount %>
										</td>
										<td>
											<%= new Date(category.createdAt).toLocaleDateString() %>
										</td>
										<td>
											<%= new Date(category.updatedAt).toLocaleDateString() %>
										</td>
										<td><a href="/admin/categoryManagement/update/<%= category._id %>" class="btn btn-primary btn-sm">Update</a></td>
										<td>
											<button data-id="<%= category._id %>" class="btn btn-success btn-sm btn-delete">Unlink</button>
										</td>
									</tr>
									<% }); %>
								</tbody>
							</table>
						</div>
					</div>
				</div>

				<!-- Action Buttons -->
				<div class="row mt-4">
					<div class="col-md-6 offset-md-3 text-center">
						<button class="btn btn-primary btn-lg mb-2" id="btn-add-cat">Create New Category</button>
						<button class="btn btn-danger btn-lg" id="btn-del-cat">Unlisted Categories</button>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- JavaScript -->
	<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
	<script>
		// SOFT DELETE PRODUCT
		document.querySelectorAll('.btn-delete').forEach(button => {
			button.addEventListener('click', function(e) {
				const categoryId = e.target.getAttribute('data-id');

				fetch(`/admin/categoryManagement/unlink`, {
						method: 'PUT',
						headers: {
							'Content-Type': 'application/json'
						},
						body: JSON.stringify({
							categoryId: categoryId
						})
					})
					.then(response => response.json())
					.then(data => {
						if(data.success) {
							window.location.reload();
						} else {
							Swal.fire({
								icon: 'error',
								title: 'Oops...',
								text: 'Could not delete the category!',
								confirmButtonColor: '#d33',
								confirmButtonText: 'OK'
							});
						}
					})
					.catch(error => {
						console.error('Error:', error);
						Swal.fire({
							icon: 'error', // Adds a red error icon
							title: 'Error!',
							text: 'An error occurred while deleting the category.',
							confirmButtonColor: '#d33', // Red button for confirmation
							confirmButtonText: 'OK'
						});
					});
			});
		});

		// ADDING CATEGORY
		document.getElementById('btn-add-cat').addEventListener('click', () => {
			window.location.href = '/admin/categoryManagement/add';
		});

		// DELETE CATEGORY
		document.getElementById('btn-del-cat').addEventListener('click', () => {
			window.location.href = '/admin/categoryManagement/del';
		});
	</script>
</body>

</html>