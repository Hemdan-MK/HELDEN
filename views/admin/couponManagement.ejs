<!DOCTYPE html>
<html lang="en">

<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Coupon Management</title>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/admin/admin.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

</head>

<body>
	<div class="sidebar">
        <div class="sidebar-brand">
            <span class="brand-full">H E L D E N</span>
            <span class="brand-short">H</span>
        </div>
        <ul class="nav flex-column mt-3">
            <li class="nav-item">
                <a class="nav-link" href="/admin/dashboard">
                    <i class="fas fa-th-large"></i>
                    <span>Dashboard</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/admin/userManagement">
                    <i class="fas fa-users"></i>
                    <span>User Management</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/admin/productManagement">
                    <i class="fas fa-box"></i>
                    <span>Product Management</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/admin/orderManagement">
                    <i class="fas fa-shopping-cart"></i>
                    <span>Order Management</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/admin/categoryManagement">
                    <i class="fas fa-folder"></i>
                    <span>Category Management</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link active" href="/admin/couponManagement">
                    <i class="fas fa-ticket-alt"></i>
                    <span>Coupon Management</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link " href="/admin/referralManagement">
                    <i class="fas fa-gift"></i>
                    <span>Referal Management</span>
                </a>
            </li>
            <li class="nav-item bottom">
                <a class="nav-link text-warning" href="/admin/logout">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </a>
            </li>
        </ul>
    </div>
	<div class="main-content">
		<!-- Sidebar -->

		<div class="container-fluid page-body-wrapper " style="height: 100vh;">
			<div class="row cc">
				<div class="col-12">
					<div class="card " style="height: 100vh;">
						<div class="card-body ">
							<div class="d-flex justify-content-between">
								<h2 class="mb-4 pt-3">Coupon Management</h2>
								<div class="text-right mb-3">
									<button class="btn  btn-outline-success" id="addCouponBtn">Add New Coupon</button>
								</div>
							</div>
							<div class="mt-4 ">

								<!-- Coupon Table -->
								<div class="table-responsive " style=" border: 1px solid #2e2e2e; border-radius: 16px; background-color: #1e1e2d;">
									<table class="">
										<thead>
											<tr>
												<th style="color: #00adb5 !important;">Coupon Code</th>
												<th style="color: #00adb5 !important;">Valid From</th>
												<th style="color: #00adb5 !important;">Valid Upto</th>
												<th style="color: #00adb5 !important;">Discount (%)</th>
												<th style="color: #00adb5 !important;">Min Price</th>
												<th style="color: #00adb5 !important;">Max Discount</th>
												<th style="color: #00adb5 !important;">Coupon Count</th>
												<th style="color: #00adb5 !important;">Status</th>
												<th style="color: #00adb5 !important;">Actions</th>
											</tr>
										</thead>
										<tbody id="couponTableBody">
											<!-- Dynamic Content -->
										</tbody>
									</table>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- Add/Update Modal -->
		<div class="modal fade" id="couponModal" tabindex="-1" aria-labelledby="modalTitle" aria-hidden="true">
			<div class="modal-dialog modal-lg modal-dialog-centered">
				<div class="modal-content shadow">
					<div class="modal-header bg-primary text-white">
						<h5 class="modal-title" id="modalTitle">Add Coupon</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
					</div>
					<div class="modal-body">
						<form id="couponForm" class="needs-validation" novalidate>
							<input type="hidden" id="couponId" />
							<div class="row g-3">
								<div class="col-md-6">
									<label for="couponCode" class="form-label">Coupon Code</label>
									<input type="text" class="form-control" id="couponCode" placeholder="Enter coupon code" required>
									<div class="invalid-feedback">Please provide a coupon code.</div>
								</div>
								<div class="col-md-6">
									<label for="discountPercentage" class="form-label">Discount (%)</label>
									<input type="number" class="form-control" id="discountPercentage" placeholder="Enter discount percentage" required>
									<div class="invalid-feedback">Please provide a valid discount percentage.</div>
								</div>
							</div>
							<div class="row g-3 mt-3">
								<div class="col-md-6">
									<label for="validFrom" class="form-label">Valid From</label>
									<input type="date" class="form-control" id="validFrom" required>
									<div class="invalid-feedback">Please select a start date.</div>
								</div>
								<div class="col-md-6">
									<label for="validUpto" class="form-label">Valid Upto</label>
									<input type="date" class="form-control" id="validUpto" required>
									<div class="invalid-feedback">Please select an end date.</div>
								</div>
							</div>
							<div class="row g-3 mt-3">
								<div class="col-md-4">
									<label for="minPrice" class="form-label">Min Price</label>
									<input type="number" class="form-control" id="minPrice" placeholder="Enter minimum price" required>
									<div class="invalid-feedback">Please provide a valid minimum price.</div>
								</div>
								<div class="col-md-4">
									<label for="maxDiscount" class="form-label">Max Discount</label>
									<input type="number" class="form-control" id="maxDiscount" placeholder="Enter maximum discount" required>
									<div class="invalid-feedback">Please provide a valid maximum discount.</div>
								</div>
								<div class="col-md-4">
									<label for="couponCount" class="form-label">Coupon Count</label>
									<input type="number" class="form-control" id="couponCount" placeholder="Enter coupon count" required>
									<div class="invalid-feedback">Please provide a valid coupon count.</div>
								</div>
							</div>
							<div class="mt-3">
								<label for="status" class="form-label">Status</label>
								<select class="form-select" id="status" required>
									<option value="true" selected>Active</option>
									<option value="false">Inactive</option>
								</select>
								<div class="invalid-feedback">Please select a status.</div>
							</div>
							<button type="submit" class="btn btn-primary w-100 mt-4">Save</button>
						</form>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Scripts -->
	<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
	<script>
		const couponForm = document.getElementById('couponForm');
		const couponModal = $('#couponModal');
		let editingCouponId = null;

		document.addEventListener('DOMContentLoaded', fetchCoupons);

		// Fetch Coupons
		async function fetchCoupons() {
			const res = await fetch('/admin/couponManagement', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json'
				}
			});
			const coupons = await res.json();
			const tableBody = document.getElementById('couponTableBody');
			tableBody.innerHTML = '';
			coupons.forEach(coupon => {
				tableBody.innerHTML += `
                    <tr>
                        <td >${coupon.couponCode}</td>
                        <td >${new Date(coupon.validFrom).toLocaleDateString()}</td>
                        <td >${new Date(coupon.validUpto).toLocaleDateString()}</td>
                        <td >${coupon.discountPercentage}</td>
                        <td >${coupon.minPrice}</td>
                        <td >${coupon.maxDiscount}</td>
                        <td >${coupon.couponCount}</td>
                        <td >${coupon.status ? 'Active' : 'Inactive'}</td>
                        <td >
                            <button class="btn  btn-sm btn-warning" onclick="openModal('${coupon._id}')">Edit</button>
                            <button class="btn btn-outline-danger btn-sm" onclick="deleteCoupon('${coupon._id}')">Delete</button>
                        </td>
                    </tr>`;
			});
		}

		// Add Event Listener for Add Coupon Button
		document.getElementById('addCouponBtn').addEventListener('click', () => {
			openModal(); // Open Modal for Adding Coupon
		});

		// Open Modal for Add/Update
		function openModal(id = null) {
			editingCouponId = id;
			couponForm.reset(); // Reset form fields
			document.getElementById('modalTitle').innerText = id ? 'Update Coupon' : 'Add Coupon';

			if(id) {
				fetch(`/admin/couponManagement/${id}`)
					.then(res => res.json())
					.then(coupon => {
						document.getElementById('couponCode').value = coupon.couponCode;
						document.getElementById('validFrom').value = coupon.validFrom.split('T')[0];
						document.getElementById('validUpto').value = coupon.validUpto.split('T')[0];
						document.getElementById('discountPercentage').value = coupon.discountPercentage;
						document.getElementById('minPrice').value = coupon.minPrice;
						document.getElementById('maxDiscount').value = coupon.maxDiscount;
						document.getElementById('couponCount').value = coupon.couponCount;
						document.getElementById('status').value = coupon.status;
					});
			}
			couponModal.modal('show');
		}

		// Submit Form
		couponForm.addEventListener('submit', async (e) => {
			e.preventDefault();


			const couponCode = couponForm.couponCode.value.trim();
			const couponRegex = /^[A-Z0-9]{6,12}$/;
			if(!couponRegex.test(couponCode)) {
				Swal.fire({
					icon: 'error',
					title: 'Invalid Coupon Code',
					text: 'Coupon code must be 6-12 characters long and contain only uppercase letters and digits.',
				});
				return;
			}

			// Validate discount percentage
			const discountPercentage = Number(couponForm.discountPercentage.value);
			if(discountPercentage <= 0 || discountPercentage > 70) {
				Swal.fire({
					icon: 'error',
					title: 'Invalid Discount Percentage',
					text: 'Discount percentage must be between 1% and 70%.',
				});
				return;
			}

			// Validate dates
			const validFrom = new Date(couponForm.validFrom.value);
			const validUpto = new Date(couponForm.validUpto.value);
			if(validFrom >= validUpto) {
				Swal.fire({
					icon: 'error',
					title: 'Invalid Date Range',
					text: 'The "Valid From" date must be earlier than the "Valid Upto" date.',
				});
				return;
			}

			// Validate minPrice and maxDiscount
			const minPrice = Number(couponForm.minPrice.value);
			const maxDiscount = Number(couponForm.maxDiscount.value);
			if(minPrice <= 0 || maxDiscount <= 0) {
				Swal.fire({
					icon: 'error',
					title: 'Invalid Values',
					text: 'Min Price and Max Discount must be positive numbers.',
				});
				return;
			}

			if(maxDiscount > minPrice) {
				Swal.fire({
					icon: 'error',
					title: 'Max Discount Exceeds Min Price',
					text: 'Max Discount cannot be greater than the Minimum Price.',
				});
				return;
			}

			const data = {
				couponCode: couponForm.couponCode.value,
				validFrom: couponForm.validFrom.value,
				validUpto: couponForm.validUpto.value,
				discountPercentage: couponForm.discountPercentage.value,
				minPrice: couponForm.minPrice.value,
				maxDiscount: couponForm.maxDiscount.value,
				couponCount: couponForm.couponCount.value,
				status: couponForm.status.value === "true"
			};

			const url = editingCouponId ? `/admin/couponManagement/edit/${editingCouponId}` : '/admin/couponManagement/add';
			const method = editingCouponId ? 'PUT' : 'POST';

			await fetch(url, {
				method,
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify(data),
			});

			couponModal.modal('hide');
			fetchCoupons(); // Refresh table
		});

		// Delete Coupon
		async function deleteCoupon(id) {
			Swal.fire({
				title: 'Are you sure?',
				text: 'You won’t be able to undo this action!',
				icon: 'warning',
				showCancelButton: true,
				confirmButtonColor: '#d33',
				cancelButtonColor: '#3085d6',
				confirmButtonText: 'Yes, delete it!',
				cancelButtonText: 'Cancel'
			}).then(async (result) => {
				if(result.isConfirmed) {
					try {
						const response = await fetch(`/admin/couponManagement/delete/${id}`, {
							method: 'DELETE'
						});

						if(response.ok) {
							Swal.fire(
								'Deleted!',
								'The coupon has been deleted.',
								'success'
							);
							fetchCoupons(); // Refresh the coupon list
						} else {
							Swal.fire(
								'Error!',
								'There was an issue deleting the coupon. Please try again.',
								'error'
							);
						}
					} catch (error) {
						Swal.fire(
							'Error!',
							'An unexpected error occurred. Please try again later.',
							'error'
						);
					}
				}
			});
		}
	</script>

</body>

</html>