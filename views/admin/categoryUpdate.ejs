<!DOCTYPE html>
<html lang="en">

<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Category Panel</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/admin/admin.css">
<link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
	.photoSelectContainer {
		display: flex;
		justify-content: center;
		align-items: center;
		flex-direction: column;
		gap: 15px;
	}

	.roundPhotoInput {
		display: flex;
		justify-content: center;
		align-items: center;
		max-width: 300px;
		min-height: 300px;
		border: 5px solid #ffb700;
		border-radius: 8px;
		cursor: pointer;
		overflow: hidden;
		background-color: #f9f9f9;
		position: relative;
	}
	.roundPhotoInput img {
		width: 100%;
		height: 100%;
		object-fit: cover;
		border-radius: 50%;
	}

	.roundPhotoInput:hover {
		border-color: #007bff;
	}

	
</style>
</head>

<body>
	<div class="sidebar">
		<div class="sidebar-brand">
			H E L D E N
		</div>
		<ul class="nav flex-column mt-3">
			<li class="nav-item">
				<a class="nav-link" href="/admin/dashboard">Dashboard</a>
			</li>
			<li class="nav-item">
				<a class="nav-link" href="/admin/userManagement">User Management</a>
			</li>
			<li class="nav-item">
				<a class="nav-link" href="/admin/productManagement">Product Management</a>
			</li>
			<li class="nav-item">
				<a class="nav-link" href="/admin/orderManagement">Order Management</a>
			</li>
			<li class="nav-item">
				<a class="nav-link active" href="/admin/categoryManagement">Category Management</a>
			</li>
			<li class="nav-item">
				<a class="nav-link" href="/admin/couponManagement">Coupon Management</a>
			</li>
			<li class="nav-item mt-5">
				<a class="nav-link text-warning" href="/admin/logout">Logout</a>
			</li>
		</ul>
	</div>
	<div class="main-content">
		<div class="container-fluid page-body-wrapper">
			

			<!-- /////////////////////////////////////////////////////// -->
			<div class="row p-3 w-100 h-100">
				<div class="col-12 grid-margin">
					<div class="card" style="padding: 0px;">
						<div class="card-body" >
							<h4 class="card-title text-center h3">Update Category</h4>
							<hr class="bg-light">
							<form id="updateCat">
								<input type="hidden" name="categoryId" value="<%= category._id %>" class="categoryId">
								<div class="form-group">
									<label for="categoryName">Category Name</label>
									<input type="text" class="form-control" id="categoryName" name="categoryName" value="<%= category.name %>" required>
								</div>
								<div class="form-group photoSelectContainer">
									<div class="roundPhotoInput" id="photoInputContainer">
										<img id="roundPreview" alt="Preview" src="<%= category.image %>" />
									</div>
									<input type="file" id="categoryImage" accept="image/*" class="form-control btn bg-secondary w-75 " onchange="openCropModal(event)" />
									<button type="button" class="btn btn-outline-danger delete-button" onclick="removeImagePreview()">Remove Image</button>
								</div>
								<div class="form-group">
									<label for="categoryDescription">Description</label>
									<input type="text" class="form-control" id="categoryDescription" name="categoryDescription" value="<%= category.description %>">
								</div>
								<div class="d-flex justify-content-center ">
									<button type="submit" class="btn btn-primary mt-2 w-50 ">Update</button>
								</div>
							</form>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<div id="cropModal" class="modal">
		<div class="modal-content">
			<span class="close" onclick="closeCropModal()">&times;</span>
			<h4>Crop Your Image</h4>
			<img id="cropModalImage" alt="Crop Preview" />
			<button class="btn btn-success mt-3" onclick="applyCrop()">OK</button>
		</div>
	</div>


	<script>
		let cropper;
		let selectedFile;
		let croppedImageBlob = null; // Variable to store the cropped image

		function openCropModal(event) {
			selectedFile = event.target.files[0];
			if(selectedFile) {
				const allowedTypes = ["image/jpeg", "image/png", "image/gif", "image/webp"];
				if(!allowedTypes.includes(selectedFile.type)) {
					Swal.fire({
						icon: 'warning', // Yellow warning icon
						title: 'Invalid File!',
						text: 'Please select a valid image file (JPEG, PNG, GIF, or WebP).',
						confirmButtonColor: '#f8b400', // Yellow button for a warning
						confirmButtonText: 'OK'
					});
					event.target.value = ""; // Clear the invalid file input
					return;
				}
				const modalImage = document.getElementById('cropModalImage');
				modalImage.src = URL.createObjectURL(selectedFile);
				document.getElementById('cropModal').style.display = 'block';

				// Initialize cropper
				if(cropper) cropper.destroy();
				cropper = new Cropper(modalImage, {
					aspectRatio: 1,
					viewMode: 1,
				});
			}
		}

		function closeCropModal() {
			document.getElementById('cropModal').style.display = 'none';
			if(cropper) cropper.destroy();
		}

		function applyCrop() {
			if(cropper) {
				cropper.getCroppedCanvas().toBlob((blob) => {
					croppedImageBlob = blob; // Store the cropped image in memory

					// Update the preview image
					const previewImage = document.getElementById('roundPreview');
					previewImage.src = URL.createObjectURL(blob);
					previewImage.style.display = 'block';

					closeCropModal();
				});
			}
		}

		function removeImagePreview() {
			const previewImage = document.getElementById('roundPreview');
			previewImage.style.display = 'none'; // Hide the preview image
			previewImage.src = ''; // Clear the preview image source
			document.getElementById('categoryImage').value = ''; // Reset file input
			croppedImageBlob = null; // Clear the stored cropped image

			if(cropper) cropper.destroy(); // Destroy the cropper instance if it exists
		}

		////////////////////////////////////////////////////////////////
		document.getElementById("updateCat").addEventListener('submit', async function(e) {
			e.preventDefault();

			const form = e.target;
			const formData = new FormData(form);

			// Append the cropped image if available
			if(croppedImageBlob) {
				formData.append('categoryImage', croppedImageBlob, 'category.jpg');
			}

			try {
				const response = await fetch('/admin/categoryManagement/update', {
					method: 'PUT',
					body: formData, // Use FormData
				});

				const data = await response.json();
				if(data.success) {
					// Success alert
					Swal.fire({
						title: 'Success!',
						text: 'Category updated successfully!',
						icon: 'success',
						confirmButtonColor: '#6a1b9a', // Purple confirm button
					}).then(() => {
						window.location.href = '/admin/categoryManagement';
					});
				} else {
					Swal.fire({
						title: 'Error',
						text: data.message || 'Failed to update category.',
						icon: 'error',
						confirmButtonColor: '#d33', // Red confirm button
					});
				}
			} catch (error) {
				console.error('Error updating category:', error);
				alert('An error occurred while updating the category.');
			}
		});
	</script>
	<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
	<script>

	</script>

</body>

</html>