<!DOCTYPE html>
<html lang="en">

<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Category Panel</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/admin/admin.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

</head>


<body>
	<div class="sidebar">
        <div class="sidebar-brand">
            <span class="brand-full">H E L D E N</span>
            <span class="brand-short">H</span>
        </div>
        <ul class="nav flex-column mt-3">
            <li class="nav-item">
                <a class="nav-link" href="/admin/dashboard">
                    <i class="fas fa-th-large"></i>
                    <span>Dashboard</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/admin/userManagement">
                    <i class="fas fa-users"></i>
                    <span>User Management</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/admin/productManagement">
                    <i class="fas fa-box"></i>
                    <span>Product Management</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link active" href="/admin/orderManagement">
                    <i class="fas fa-shopping-cart"></i>
                    <span>Order Management</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/admin/categoryManagement">
                    <i class="fas fa-folder"></i>
                    <span>Category Management</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/admin/couponManagement">
                    <i class="fas fa-ticket-alt"></i>
                    <span>Coupon Management</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link " href="/admin/referralManagement">
                    <i class="fas fa-gift"></i>
                    <span>Referal Management</span>
                </a>
            </li>
            <li class="nav-item bottom">
                <a class="nav-link text-warning" href="/admin/logout">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </a>
            </li>
        </ul>
    </div>
	<div class="main-content">
		<div class="container-fluid" style="width: 100%;height: 100vh;">
			<!-- Main Content -->
			<h2 class="mb-4 pt-3">Order Management</h2>
			<!-- Orders Table -->
			<div class="table-responsive">
				<table>
					<thead>
						<tr>
							<th style="color: #00adb5 !important;">Index</th>
							<th style="color: #00adb5 !important;">Order No</th>
							<th style="color: #00adb5 !important;">User Name</th>
							<th style="color: #00adb5 !important;">Date</th>
							<th style="color: #00adb5 !important;">Price</th>
							<th style="color: #00adb5 !important;">Payment Status</th>
							<th style="color: #00adb5 !important;">Status</th>
							<th style="color: #00adb5 !important;">Payment Mode</th>
							<th style="color: #00adb5 !important;">Action</th>
						</tr>
					</thead>
					<tbody>
						<% orders.forEach((order, index) => { %>
						<tr>
							<td><%= index + 1 %></td>
							<td><%= order._id %></td>
							<td><%= order.userId.name %></td>
							<td><%= new Date(order.createdAt).toLocaleDateString() %></td>
							<td>â‚¹ <%= order.totalAmount.toFixed(2) %></td>
							<td><%= order.paymentStatus %></td>
							<td><%= order.status %></td>
							<td><%= order.paymentMethod %></td>
							<td>
								<button class="btn btn-info position-relative btn-sm" onclick="viewOrder('<%= order._id %>')">
									View
									<% if (order.status === 'Requested') { %>
									<span class="badge bg-warning position-absolute" style="top: -5px; right: -5px;">1</span>
									<% } %>
								</button>
							</td>
						</tr>
						<% }); %>
					</tbody>
				</table>
			</div>

			<!-- Pagination -->
			<div class="pagination-container my-4">
				<ul class="pagination pagination-dark justify-content-center">
					<% if (currentPage > 1) { %>
					<li class="page-item">
						<a class="page-link" href="?page=<%= currentPage - 1 %>&limit=<%= limit %>">
							<span>&laquo; Previous</span>
						</a>
					</li>
					<% } %>

					<% for (let i = 1; i <= totalPages; i++) { %>
					<li class="page-item <%= currentPage === i ? 'active' : '' %>">
						<a class="page-link" href="?page=<%= i %>&limit=<%= limit %>"><%= i %></a>
					</li>
					<% } %>

					<% if (currentPage < totalPages) { %>
					<li class="page-item">
						<a class="page-link" href="?page=<%= currentPage + 1 %>&limit=<%= limit %>">
							<span>Next &raquo;</span>
						</a>
					</li>
					<% } %>
				</ul>
			</div>
		</div>
	</div>


	<!-- Modal for Viewing Order Details -->
	<div class="modal fade" id="orderModal" tabindex="-1" role="dialog" aria-labelledby="orderModalLabel" aria-hidden="true">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="orderModalLabel">Order Details</h5>
				</div>
				<div class="modal-body">
					<form id="orderForm">
						<div class="form-group">
							<label for="orderNo">Order No</label>
							<input type="text" class="form-control" id="orderNo" disabled>
						</div>
						<div class="form-group">
							<label for="userName">User Name</label>
							<input type="text" class="form-control" id="userName" disabled>
						</div>
						<div class="form-group">
							<label for="orderItems">Order Items</label>
							<div id="orderItemsContainer"></div>
						</div>
						<div class="form-group">
							<label for="shippingStatus">Shipping Status</label>
							<select class="form-control" id="shippingStatus">
								<option value="Pending">Pending</option>
								<option value="Shipping">Shipping</option>
								<option value="Completed">Completed</option>
								<option value="Returned">Returned</option>
								<option value="Requested">Requested</option>
								<option value="Rejected">Rejected</option>
								<option value="Cancelled">Cancelled</option>
							</select>
						</div>
						<div class="form-group">
							<label for="paymentStatus">Payment Status</label>
							<select class="form-control" id="paymentStatus">
								<option value="Pending">Pending</option>
								<option value="Completed">Completed</option>
								<option value="Failed">Failed</option>
							</select>
						</div>
						<div class="form-group">
							<label for="totalAmount">Total Amount</label>
							<input type="text" class="form-control" id="totalAmount" disabled>
						</div>
						<div class="ret" id="ret">
							<div class="form-group">
								<label for="reason">Reason</label>
								<textarea class="form-control" id="reason" rows="3" readonly></textarea>
							</div>
							<div class="form-group d-flex justify-content-between">
								<button type="button" class="btn btn-danger" id="rejectBtn">Reject</button>
								<button type="button" class="btn btn-success" id="acceptBtn">Accept</button>
							</div>
						</div>
					</form>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
					<button type="button" class="btn btn-primary" id="updateStatusBtn">Status Action</button>
				</div>
			</div>
		</div>
	</div>
	</div>


	<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>

	<script>
		// Function to populate and show order details in the modal
		function viewOrder(orderId) {
			fetch(`/admin/orderManagement/getOrderDetails/${orderId}`)
				.then(response => response.json())
				.then(order => {

					// Populate the order details in the modal
					document.getElementById('orderNo').value = order._id;
					document.getElementById('userName').value = order.userId.name;

					// Build order items HTML to show product details along with images
					const orderItemsHtml = order.orderItems.map(item => {
						return `
            <div class="row mb-3">
              <div class="col-2">
                <img src="${item.productId.images[0]}" alt="${item.productId.name}" class="img-fluid" style="max-height: 50px; object-fit: cover;" />
              </div>
              <div class="col-10">
                <div class="d-flex justify-content-between">
                  <span><strong>Product:</strong> ${item.productId.name}</span>
                  <span><strong>Price:</strong> Rs.${item.price}</span>
                </div>
                <div class="d-flex justify-content-between">
                  <span><strong>Quantity:</strong> ${item.quantity}</span>
                </div>
              </div>
            </div>
          `;

					}).join('');

					// Set the order items HTML to an element (not a text input)
					document.getElementById('orderItemsContainer').innerHTML = orderItemsHtml;
					if(order.status !== 'Requested') {
						document.getElementById('ret').style.display = 'none';
					}
					document.getElementById('shippingStatus').value = order.status;
					document.getElementById('paymentStatus').value = order.paymentStatus;
					document.getElementById('totalAmount').value = order.totalAmount;
					document.getElementById('reason').value = order.refundReason;

					// Check if the order status is "Returned" or "Completed"
					if(order.status === 'Returned' || order.status === 'Completed' || order.status === 'Cancelled' || order.status === 'Rejected' || order.status === 'Requested') {
						// Disable editing of shipping and payment status if the order is Returned or Completed
						document.getElementById('shippingStatus').disabled = true;
						document.getElementById('paymentStatus').disabled = true;
						document.getElementById('updateStatusBtn').disabled = true; // Optionally disable the update button
					} else {
						document.getElementById('shippingStatus').disabled = false;
						document.getElementById('paymentStatus').disabled = false;
						document.getElementById('updateStatusBtn').disabled = false; // Enable the update button
					}



					// Show the modal
					$('#orderModal').modal('show');
				})
				.catch(err => console.error('Error fetching order details:', err));
		}

		// Update the order status and payment status
		document.getElementById('updateStatusBtn').addEventListener('click', () => {
			const orderId = document.getElementById('orderNo').value;
			const shippingStatus = document.getElementById('shippingStatus').value;
			const paymentStatus = document.getElementById('paymentStatus').value;

			fetch(`/admin/orderManagement/updateOrderStatus/${orderId}`, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify({
						shippingStatus,
						paymentStatus
					})
				})
				.then(response => response.json())
				.then(data => {
					$('#orderModal').modal('hide');
					Swal.fire({
						icon: 'info', // Default to an 'info' icon, you can adjust based on the type of message
						title: 'Message',
						text: data.message,
						confirmButtonColor: '#3085d6', // Blue color for confirmation
						confirmButtonText: 'OK'
					}).then(() => {
						location.reload(); // Reload to reflect changes
					})
				})
				.catch(error => console.error('Error updating status:', error));
		});

		// Handle accept and reject actions for the reason
		document.getElementById('acceptBtn').addEventListener('click', () => {
			fetch(`/admin/orderManagement/acceptReason/${document.getElementById('orderNo').value}`, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					},
				})
				.then(response => response.json())
				.then(data => {
					Swal.fire('Accepted', data.message, 'success').then(() => {
						$('#orderModal').modal('hide');
					})
				})
				.catch(error => console.error('Error accepting reason:', error));
		});

		document.getElementById('rejectBtn').addEventListener('click', () => {
			fetch(`/admin/orderManagement/rejectReason/${document.getElementById('orderNo').value}`, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					}
				})
				.then(response => response.json())
				.then(data => {
					Swal.fire('Rejected', data.message, 'error');
				})
				.catch(error => console.error('Error rejecting reason:', error));
		});
	</script>

</body>

</html>