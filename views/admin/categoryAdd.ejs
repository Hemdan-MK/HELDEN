<!DOCTYPE html>
<html lang="en">

<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
<title>Category Panel</title>
<link href="https://unpkg.com/cropperjs@1.5.12/dist/cropper.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/admin/admin.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
	/* Circular input and preview styles */
	.photoSelectContainer {
		display: flex;
		justify-content: center;
		align-items: center;
		flex-direction: column;
		gap: 15px;
	}

	.roundPhotoInput {
		display: flex;
		justify-content: center;
		align-items: center;
		max-width: 300px;
		min-height: 300px;
		border: 5px solid #ffb700;
		border-radius: 8px;
		cursor: pointer;
		overflow: hidden;
		background-color: #f9f9f9;
		position: relative;
	}

	.roundPhotoInput img {
		width: 110%;
		height: 100%;
		object-fit: contain;
		display: none;
	}

	.roundPhotoInput:hover {
		border-color: #007bff;
	}


	.modal {
		display: none;
		position: fixed;
		z-index: 1000;
		left: 0;
		top: 0;
		width: 100%;
		height: 100% !important;
		overflow: auto;
		background-color: rgba(0, 0, 0, 0.5);
	}

	.modal-content {
		margin: 15% auto;
		padding: 20px 0;
		width: 60%;
		background: #2b3037;
		border-radius: 10px;
		text-align: center;
		position: relative;
	}

	.modal-content img {
		max-width: 100%;
		max-height: 400px;
	}

	.close {
		position: absolute;
		right: 10px;
		top: 10px;
		color: #aaa;
		font-size: 24px;
		cursor: pointer;
	}

	.close:hover {
		color: red;
	}
</style>
<link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>
	<div class="sidebar">
		<div class="sidebar-brand">
			<span class="brand-full">H E L D E N</span>
			<span class="brand-short">H</span>
		</div>
		<ul class="nav flex-column mt-3">
			<li class="nav-item">
				<a class="nav-link" href="/admin/dashboard">
					<i class="fas fa-th-large"></i>
					<span>Dashboard</span>
				</a>
			</li>
			<li class="nav-item">
				<a class="nav-link" href="/admin/userManagement">
					<i class="fas fa-users"></i>
					<span>User Management</span>
				</a>
			</li>
			<li class="nav-item">
				<a class="nav-link" href="/admin/productManagement">
					<i class="fas fa-box"></i>
					<span>Product Management</span>
				</a>
			</li>
			<li class="nav-item">
				<a class="nav-link" href="/admin/orderManagement">
					<i class="fas fa-shopping-cart"></i>
					<span>Order Management</span>
				</a>
			</li>
			<li class="nav-item">
				<a class="nav-link active" href="/admin/categoryManagement">
					<i class="fas fa-folder"></i>
					<span>Category Management</span>
				</a>
			</li>
			<li class="nav-item">
				<a class="nav-link" href="/admin/couponManagement">
					<i class="fas fa-ticket-alt"></i>
					<span>Coupon Management</span>
				</a>
			</li>
			<li class="nav-item">
                <a class="nav-link " href="/admin/referralManagement">
                    <i class="fas fa-gift"></i>
                    <span>Referal Management</span>
                </a>
            </li>
            <li class="nav-item bottom">
                <a class="nav-link text-warning" href="/admin/logout">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </a>
            </li>
		</ul>
	</div>
	<div class="main-content">
		<div class="container-fluid page-body-wrapper">
			<div class="row p-3">
				<div class="col-12 grid-margin">
					<div class="card">
						<div class="card-body">
							<h2 class="card-title">Add New Category</h2>
							<form id="categoryForm" onsubmit="return false;">
								<div class="form-group">
									<label for="categoryName">Category Name</label>
									<input type="text" class="form-control" id="categoryName" name="categoryName" required />
								</div>
								<div class="form-group photoSelectContainer">
									<div class="roundPhotoInput" id="photoInputContainer">
										<img id="roundPreview" alt="Preview" />
									</div>
									<input type="file" id="categoryImage" accept="image/*" class="form-control btn bg-secondary w-75" onchange="openCropModal(event)" />
									<button type="button" class="btn btn-outline-danger delete-button" onclick="removeImagePreview()">Remove Image</button>
								</div>
								<div class="form-group">
									<label for="categoryDescription">Description</label>
									<textarea type="text" class="form-control" id="categoryDescription" name="categoryDescription" required></textarea>
								</div>
								<div class="d-flex justify-content-around align-items-center" style="gap: 10px;">
									<button type="submit" class="btn btn-primary mt-4 w-50" id="add-btn">Add</button>
									<a href="/admin/categoryManagement" class="btn btn-secondary w-50 mt-4">Go to Category Page</a>
								</div>
							</form>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Modal for cropping -->
	<div id="cropModal" class="modal">
		<div class="modal-content">
			<span class="close" onclick="closeCropModal()">&times;</span>
			<h4>Crop Your Image</h4>
			<img id="cropModalImage" alt="Crop Preview" />
			<button class="btn btn-success mt-3" onclick="applyCrop()">OK</button>
		</div>
	</div>

	<!-- Script links -->
	<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
	<script src="https://unpkg.com/cropperjs@1.5.12/dist/cropper.min.js"></script>

	<script>
		let cropper;
		let selectedFile;
		let croppedImageBlob = null; // Variable to store the cropped image

		function showAlert(title, text, icon) {
			Swal.fire({
				title: title,
				text: text,
				icon: icon, // 'success', 'error', 'warning', 'info', or 'question'
				customClass: {
					popup: 'swal-purple-popup', // Use the global class
				},
			});
		}

		function openCropModal(event) {
			selectedFile = event.target.files[0];
			if(selectedFile) {
				const allowedTypes = ['image/jpeg', 'image/png', 'image/gif'];
				if(!allowedTypes.includes(selectedFile.type)) {
					showAlert('Validation Error', 'Please upload a valid image (JPEG, PNG, or GIF).', 'warning');
					event.target.value = ''; // Clear the file input
					return;
				}

				const modalImage = document.getElementById('cropModalImage');
				modalImage.src = URL.createObjectURL(selectedFile);
				document.getElementById('cropModal').style.display = 'block';

				// Initialize cropper
				if(cropper) cropper.destroy();
				cropper = new Cropper(modalImage, {
					aspectRatio: 1,
					viewMode: 1,
				});
			}
		}

		function closeCropModal() {
			document.getElementById('cropModal').style.display = 'none';
			if(cropper) cropper.destroy();
		}

		function applyCrop() {
			if(cropper) {
				cropper.getCroppedCanvas().toBlob((blob) => {
					croppedImageBlob = blob; // Store the cropped image in memory

					// Update the preview image
					const previewImage = document.getElementById('roundPreview');
					previewImage.src = URL.createObjectURL(blob);
					previewImage.style.display = 'block';

					closeCropModal();
				});
			}
		}

		function removeImagePreview() {
			const previewImage = document.getElementById('roundPreview');
			previewImage.style.display = 'none'; // Hide the preview image
			previewImage.src = ''; // Clear the preview image source
			document.getElementById('categoryImage').value = ''; // Reset file input
			croppedImageBlob = null; // Clear the stored cropped image

			if(cropper) cropper.destroy(); // Destroy the cropper instance if it exists
		}



		document.getElementById('add-btn').addEventListener('click', function(e) {
			e.preventDefault();

			// Validate form inputs
			const categoryName = document.getElementById('categoryName').value.trim();
			const categoryDescription = document.getElementById('categoryDescription').value.trim();
			const namePattern = /^[a-zA-Z0-9\& _-]{3,50}$/;

			if(!categoryName) {
				showAlert('Validation Error', 'Category Name is required.', 'warning');
				return;
			}
			if(!namePattern.test(categoryName)) {
				showAlert('Validation Error', 'Category Name must be 3-50 characters long and include valid characters.', 'warning');
				return;
			}
			if(!categoryDescription) {
				showAlert('Validation Error', 'Category Description is required.', 'warning');
				return;
			}
			if(categoryDescription.length < 10 || categoryDescription.length > 500) {
				showAlert('Validation Error', 'Category Description must be between 10 and 150 characters long.', 'warning');
				return;
			}
			if(!croppedImageBlob) {
				showAlert('Validation Error', 'Please upload and crop an image before submitting.', 'warning');
				return;
			}

			// Prepare form data
			const formData = new FormData();
			formData.append('categoryName', categoryName);
			formData.append('categoryDescription', categoryDescription);
			formData.append('categoryImage', new File([croppedImageBlob], 'croppedImage.png', {
				type: 'image/png'
			}));

			// Send data to the server
			fetch('/admin/categoryManagement/add', {
					method: 'POST',
					body: formData,
				})
				.then((response) => {
					if(!response.ok) {
						return response.json().then((err) => {
							throw new Error(err.msg || 'Failed to upload category.');
						});
					}
					return response.json();
				})
				.then((data) => {
					showAlert('Success', 'Category added successfully!', 'success');
					setTimeout(() => {
						window.location.reload();
					}, 3000)
				})
				.catch((error) => {
					console.error('Error:', error.message);
					alert(error.message);
				});
		});
	</script>
</body>

</html>