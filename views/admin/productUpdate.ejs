<!DOCTYPE html>
<html lang="en">

<head>
<!-- Required meta tags -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Product Update Panel</title>
<!-- Layout styles -->
<link rel="stylesheet" href="/admin/admin.css">
<link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
	.round-preview {
		width: 300px;
		height: 400px;
		border: 4px solid red;
		object-fit: cover;
		display: block;
	}


	.modal {
		display: none;
		position: fixed;
		z-index: 1000;
		left: 0;
		top: 0;
		width: 100%;
		height: 100%;
		overflow: auto;
		background-color: rgba(0, 0, 0, 0.5);
	}

	.modal-content {
		margin: 5% auto;
		/* padding: 20px; */
		border: 1px solid #888;
		height: 75vh;
		width: 60%;
		background-color: white;
		text-align: center;
	}

	.close {
		color: #aaa;
		float: right;
		font-size: 28px;
		font-weight: bold;
		cursor: pointer;
	}

	.delete-button {
		margin-top: 10px;
		background: transparent;
		border: 1px solid red;
		color: white;
		border-radius: 4px;
	}

	.delete-button:hover {
		background-color: red;
	}
</style>

</head>

<body>
	<div class="container-scroller">
		<!-- Sidebar Section -->
		<%- include('./layout/sidebar') %>

		<!-- partial -->
		<div class="container-fluid page-body-wrapper">
			<!-- partial:partials/_navbar.html -->
			<nav class="navbar p-0 fixed-top d-flex flex-row">
			</nav>

			<!-- Product Update Form Section -->
			<div class="row p-3 w-100 h-100">
				<div class="col-12 grid-margin">
					<div class="card">
						<div class="card-body">
							<h4 class="card-title">Update Product</h4>
							<form class="updatePdt" id="updateProductForm" enctype="multipart/form-data">
								<input type="hidden" class="form-control" id="productId" name="productId" value="<%= product.id %>" required>

								<!-- Product Name -->
								<div class="form-group">
									<label for="productName">Product Name</label>
									<input type="text" class="form-control" id="productName" name="productName" value="<%= product.name %>" required>
								</div>

								<label>Product Images</label>
								<div class="d-flex  justify-content-between">
									<!-- Image Previews -->
									<div class="text-center mx-2">
										<img id="roundPreview0" class="round-preview" src="<%= product.images[0] || '/productUploads/default-product.png' %>" alt="Preview 1" />
										<input type="file" class="form-control mt-2" id="image0" name="productImage1" accept="image/*" onchange="openCropModal(event,0)" />
										<button type="button" class="delete-button" onclick="removeImagePreview(0)">Remove Image</button>

									</div>
									<div class="text-center mx-2">
										<img id="roundPreview1" class="round-preview" src="<%= product.images[1] || '/productUploads/default-product.png' %>" alt="Preview 2" />
										<input type="file" class="form-control mt-2" id="image1" name="productImage2" accept="image/*" onchange="openCropModal(event,1)" />
										<button type="button" class="delete-button" onclick="removeImagePreview(1)">Remove Image</button>

									</div>
									<div class="text-center mx-2">
										<img id="roundPreview2" class="round-preview" src="<%= product.images[2] || '/productUploads/default-product.png' %>" alt="Preview 3" />
										<input type="file" class="form-control mt-2" id="image2" name="productImage3" accept="image/*" onchange="openCropModal(event,2)" />
										<button type="button" class="delete-button" onclick="removeImagePreview(2)">Remove Image</button>

									</div>
									<div class="text-center mx-2">
										<img id="roundPreview3" class="round-preview" src="<%= product.images[3] || '/productUploads/default-product.png' %>" alt="Preview 4" />
										<input type="file" class="form-control mt-2" id="image3" name="productImage4" accept="image/*" onchange="openCropModal(event,3)" />
										<button type="button" class="delete-button" onclick="removeImagePreview(3)">Remove Image</button>

									</div>
								</div>

								<!-- Product Description -->
								<div class="form-group">
									<label for="productDescription">Description</label>
									<textarea class="form-control" id="productDescription" name="productDescription" required><%= product.description %></textarea>
								</div>

								<!-- Product Price -->
								<div class="form-group">
									<label for="productPrice">Price</label>
									<input type="number" class="form-control" id="productPrice" name="productPrice" value="<%= product.price %>" required>
								</div>

								<!-- Offer Price -->
								<div class="form-group">
									<label for="productOfferPrice">Offer Price</label>
									<input type="number" class="form-control" id="productOfferPrice" name="productOfferPrice" value="<%= product.offerPrice %>">
								</div>

								<!-- Stock Quantity -->
								<div class="form-group">
									<label for="productStock">Stock</label>
									<input type="number" class="form-control" id="productStock" name="productStock" value="<%= product.stock %>" required>
								</div>

								<!-- Product Tags -->
								<div class="form-group">
									<label for="productTags">Tags (comma-separated)</label>
									<input type="text" class="form-control" id="productTags" name="productTags" value="<%= product.tags.join(', ') %>">
								</div>

								<!-- Sizes -->
								<div class="form-group">
									<label for="productSizes">Sizes (comma-separated)</label>
									<input type="text" class="form-control" id="productSizes" name="productSizes" value="<%= product.sizes.join(', ') %>">
								</div>

								<!-- Colors -->
								<div class="form-group">
									<label for="productColors">Colors (comma-separated)</label>
									<input type="text" class="form-control" id="productColors" name="productColors" value="<%= product.colors.join(', ') %>">
								</div>

								<!-- Category Selection -->
								<div class="form-group">
									<label for="productCategory">Category</label>
									<select class="form-control" id="productCategory" name="productCategory" required>
										<% categories.forEach(category=> { %>
										<option value="<%= category._id %>" <%=category._id.equals(product.category) ? 'selected' : '' %>><%=
                                                        category.name %>
										</option>
										<% }) %>
									</select>
								</div>

								<!-- Brand -->
								<div class="form-group">
									<label for="productBrand">Brand</label>
									<input type="text" class="form-control" id="productBrand" name="productBrand" value="<%= product.brand %>">
								</div>

								<!-- Cash on Delivery -->
								<div class="form-group">
									<label for="productCashOnDelivery">Cash on Delivery</label>
									<select class="form-control" id="productCashOnDelivery" name="productCashOnDelivery">
										<option value="true" <%=product.cashOnDelivery ? 'selected' : '' %>>Yes
										</option>
										<option value="false" <%=!product.cashOnDelivery ? 'selected' : '' %>>No
										</option>
									</select>
								</div>

								<!-- Warranty -->
								<div class="form-group">
									<label for="productWarranty">Warranty</label>
									<input type="text" class="form-control" id="productWarranty" name="productWarranty" value="<%= product.warranty %>">
								</div>

								<!-- Return Policy -->
								<div class="form-group">
									<label for="productReturnPolicy">Return Policy</label>
									<input type="text" class="form-control" id="productReturnPolicy" name="productReturnPolicy" value="<%= product.returnPolicy %>">
								</div>

								<!-- Submit Button -->
								<div class="d-flex justify-content-center">
									<button type="submit" class="btn btn-primary mt-2 w-50">Update</button>
								</div>
							</form>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>


	<!-- Modal for cropping -->
	<div id="cropModal" class="modal">
		<div class="modal-content">
			<span class="close" onclick="closeCropModal()">&times;</span>
			<h4>Crop Your Image</h4>
			<img id="cropModalImage" alt="Crop Preview" />
			<button class="btn btn-success mt-3" onclick="applyCrop()">OK</button>
		</div>
	</div>

	<script>
		let cropper;
		let selectedFile;
		let selectedInput;
		let selectedPreview;

		function openCropModal(event, index) {
			selectedFile = event.target.files[0];
			selectedInput = event.target;
			selectedPreview = document.getElementById(`roundPreview${index}`);

			if(selectedFile) {
				// Validate file type
				const allowedTypes = ["image/jpeg", "image/png", "image/gif", "image/webp"];
				if(!allowedTypes.includes(selectedFile.type)) {
					Swal.fire({
						icon: 'warning', // Yellow warning icon
						title: 'Invalid File!',
						text: 'Please select a valid image file (JPEG, PNG, GIF, or WebP).',
						confirmButtonColor: '#f8b400', // Yellow button for warning
						confirmButtonText: 'OK'
					});
					event.target.value = ""; // Clear the invalid file input
					return;
				}
				const modalImage = document.getElementById('cropModalImage');
				modalImage.src = URL.createObjectURL(selectedFile);
				document.getElementById('cropModal').style.display = 'block';

				if(cropper) cropper.destroy();
				cropper = new Cropper(modalImage, {
					aspectRatio: 3 / 4,
					viewMode: 1,
				});
			}
		}

		function closeCropModal() {
			document.getElementById('cropModal').style.display = 'none';
			if(cropper) cropper.destroy();
		}

		function applyCrop() {
			cropper.getCroppedCanvas().toBlob((blob) => {
				const croppedUrl = URL.createObjectURL(blob);
				selectedPreview.src = croppedUrl;

				// Replace file input with cropped blob
				const file = new File([blob], selectedFile.name, {
					type: selectedFile.type
				});
				const dataTransfer = new DataTransfer();
				dataTransfer.items.add(file);
				selectedInput.files = dataTransfer.files;
			});

			closeCropModal();
		}

		function removeImagePreview(index) {
			document.getElementById(`roundPreview${index}`).src = '/default-image.png';
			document.getElementById(`image${index}`).value = '';
		}
	</script>




	<script>
		// Handle form submission using fetch with PUT method
		document.getElementById('updateProductForm').addEventListener('submit', function(e) {
			e.preventDefault(); // Prevent default form submission

			const formData = new FormData(this); // Collect form data

			// Use fetch to send the data to the server with PUT method
			fetch('/admin/productManagement/update', {
					method: 'PUT',
					body: formData
				})
				.then(response => response.json()) // Assuming server returns JSON
				.then(data => {
					if(data.success) {
						Swal.fire({
							icon: 'success', // Green checkmark icon for success
							title: 'Success!',
							text: 'Product updated successfully!',
							confirmButtonColor: '#28a745', // Green button for success
							confirmButtonText: 'OK'
						}).then(()=>{

							window.location.href = '/admin/productManagement'; // Redirect to product list page
						})
					} else {
						Swal.fire({
							icon: 'error', // Red error icon
							title: 'Error!',
							text: 'Failed to update product. Please try again.',
							confirmButtonColor: '#d33', // Red button for error
							confirmButtonText: 'OK'
						});
					}
				})
				.catch(error => {
					console.error('Error:', error);
					alert('An error occurred. Please try again.');
				});
		});
	</script>

	<!-- Script links -->
	<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>