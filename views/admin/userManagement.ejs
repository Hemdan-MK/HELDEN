<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Admin Panel</title>
  <!-- End plugin css for this page -->
  <!-- inject:css -->
  <!-- endinject -->
  <!-- Layout styles -->
  <link rel="stylesheet" href="/admin/admin.css">
  <!-- End layout styles -->
  <!-- <link rel="shortcut icon" href="assets/images/favicon.png" /> -->
</head>

<body>
  <div class="container-scroller">
    <!-- partial:partials/_sidebar.html -->
    <%- include('./layout/sidebar') %>

    <!-- partial -->
    <div class="container-fluid page-body-wrapper">
      <!-- partial:partials/_navbar.html -->
      <nav class="navbar p-0 fixed-top d-flex flex-row">
      </nav>

      <!-- partial -->
      <div class="row p-3">
        <div class="col-12 grid-margin">
          <div class="card">
            <div class="card-body">
              <h4 class="card-title">Users Status</h4>
              <div class="table-responsive">
                <form class="nav-link mt-2 mt-md-0  d-lg-flex search">
                  <input type="text" class="form-control" placeholder="Search users">
                  <button style="height: 33px;margin: 3px 0px 0px 10px;" class="btn btn-primary">Search</button>
                </form>
                <table class="table">
                  <thead>
                    <tr>
                      <th> Username</th>
                      <th> Email</th>
                      <th> Role</th>
                      <th> Join Date </th>
                      <th> Ban </th>
                      <th> View </th>
                    </tr>
                  </thead>
                  <tbody>
                    <% user.forEach((value)=> { %>
                      <tr>
                        <td>
                          <%= value.name %>
                        </td>
                        <td>
                          <%= value.email %>
                        </td>
                        <td>
                          <%= value.role %>
                        </td>
                        <td>
                          <% const createdAt=new Date(value.createdAt); const day=createdAt.getDate(); const
                            month=createdAt.getMonth() + 1; const year=createdAt.getFullYear(); const formattedDate=day
                            + ":" + month + ":" + year; %>
                            <%= formattedDate %>
                        </td>
                        <td>
                          <button data-id="<%= value.email  %>" class="badge badge-outline-danger btn-ban">
                            <%= value.isDeleted?'Unban':'Ban' %>
                          </button>
                        </td>
                        <td>
                          <button data-id="<%= value.email  %>" class="badge badge-outline-warning btn-view">View</button>
                        </td>
                      </tr>
                      <% }); %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div style="margin-top:100px ;" class="col-md-4 grid-margin stretch-card userInfoView">

      </div>
    </div>
    <!-- main-panel ends -->
  </div>
  <!-- page-body-wrapper ends -->
  </div>>


  <script>
    // ban
    // ------------
    document.querySelectorAll('.btn-ban').forEach(button => {
      button.addEventListener('click', async function () {
        const email = this.getAttribute('data-id');

        try {
          const response = await fetch(`/admin/userManagement/ban?email=${email}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
            }
          });

          if (!response.ok) {
            const errorText = await response.text(); // Get error details
            throw new Error(`Failed to update ban status: ${response.status} - ${errorText}`);
          }

          const result = await response.json();
          alert(result.message);

          // Update button text and class based on the new ban status
          if (result.isDeleted) {
            this.textContent = 'Unban';
            this.classList.remove('badge-outline-danger');
            this.classList.add('badge-outline-success');
          } else {
            this.textContent = 'Ban';
            this.classList.remove('badge-outline-success');
            this.classList.add('badge-outline-danger');
          }

        } catch (error) {
          console.error('Error toggling ban status:', error.message);
          alert(`Error toggling ban status: ${error.message}`);
        }
      });
    });



  </script>
  <script>

    // view
    //----------- 
    document.querySelectorAll('.btn-view').forEach(button => {
      button.addEventListener('click', async function () {
        const email = this.getAttribute('data-id');

        try {
          const response = await fetch(`/admin/userManagement/view?email=${email}`, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
            }
          });

          if (!response.ok) {
            throw new Error('Failed to fetch user details'); // Handle HTTP errors
          }

          const userDetails = await response.json();

          // Display user details in the UI (e.g., in a modal or dedicated section)
          document.querySelector('.userInfoView').innerHTML = `
            <h4>User Details</h4>
            <p><strong>Username:</strong> ${userDetails.username}</p>
            <p><strong>Email:</strong> ${userDetails.email}</p>
            <p><strong>Role:</strong> ${userDetails.role}</p>
            <p><strong>Join Date:</strong> ${userDetails.joinDate}</p>
            <p><strong>Status:</strong> ${userDetails.isDeleted ? 'Banned' : 'Active'}</p>
          `;

        } catch (error) {
          console.log('Error fetching user details:', error);
          alert('Failed to retrieve user details');
        }
      });
    });
  </script>



</body>

</html>